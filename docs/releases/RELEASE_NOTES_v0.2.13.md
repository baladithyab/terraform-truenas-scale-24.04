# Release Notes - v0.2.13

**Release Date:** 2025-10-31

## üéâ Major Feature: VM Device Configuration

This release adds comprehensive device configuration support to the VM resource, allowing you to create fully functional VMs with network interfaces, disks, and CDROM devices directly through Terraform.

### What's New

#### VM Device Support

You can now configure three types of devices when creating VMs:

1. **Network Interface Devices (`nic_devices`)**
   - Configure VIRTIO, E1000, or other NIC types
   - Attach to physical network interfaces (e.g., `eno1`, `br0`)
   - Auto-generate MAC addresses or specify custom ones
   - Control guest RX filter trust settings

2. **Disk Devices (`disk_devices`)**
   - Attach zvol or file-based disks
   - Choose disk types (VIRTIO, AHCI, SCSI)
   - Configure IO types (THREADS, NATIVE)
   - Set sector sizes if needed

3. **CDROM Devices (`cdrom_devices`)**
   - Mount ISO files for OS installation
   - Support for multiple CDROMs
   - Perfect for Talos Linux, Ubuntu, or other OS deployments

### Why This Matters

**Before v0.2.13:**
- VMs created by Terraform had NO devices attached
- No network connectivity - VMs couldn't reach the network
- No storage - VMs couldn't boot or store data
- Manual device configuration required through TrueNAS UI

**After v0.2.13:**
- ‚úÖ VMs are created with full device configuration
- ‚úÖ Network connectivity works out of the box
- ‚úÖ Storage devices properly attached
- ‚úÖ ISO files mounted for installation
- ‚úÖ Everything managed through Terraform code

### Example Usage

#### Basic VM with Devices

```hcl
resource "truenas_vm" "example" {
  name   = "myvm"
  memory = 4096
  vcpus  = 2

  # Network interface
  nic_devices = [{
    type       = "VIRTIO"
    nic_attach = "eno1"
    # MAC auto-generated if not specified
  }]

  # Boot disk
  disk_devices = [{
    path = "/dev/zvol/pool/vms/myvm-disk0"
    type = "VIRTIO"
  }]

  # Installation ISO
  cdrom_devices = [{
    path = "/mnt/pool/isos/ubuntu-22.04.iso"
  }]
}
```

#### Talos Linux Worker Node

```hcl
resource "truenas_vm" "talos_worker" {
  name   = "talosworker01"
  memory = 8192
  vcpus  = 4

  nic_devices = [{
    type       = "VIRTIO"
    nic_attach = "eno1"
  }]

  disk_devices = [{
    path   = "/dev/zvol/pool/vms/talos-worker-01-disk0"
    type   = "VIRTIO"
    iotype = "THREADS"
  }]

  cdrom_devices = [{
    path = "/mnt/pool/isos/talos-v1.10.6-metal-amd64.iso"
  }]

  bootloader      = "UEFI"
  start_on_create = true
}

# Get MAC address for static IP configuration
output "talos_worker_mac" {
  value = truenas_vm.talos_worker.mac_addresses
}
```

#### Multiple NICs and Disks

```hcl
resource "truenas_vm" "multi_device" {
  name   = "multidevicevm"
  memory = 16384
  vcpus  = 8

  # Two network interfaces
  nic_devices = [
    {
      type       = "VIRTIO"
      nic_attach = "eno1"  # Management network
    },
    {
      type       = "VIRTIO"
      nic_attach = "eno2"  # Data network
    }
  ]

  # Two disks
  disk_devices = [
    {
      path = "/dev/zvol/pool/vms/multi-os-disk"
      type = "VIRTIO"
    },
    {
      path = "/dev/zvol/pool/vms/multi-data-disk"
      type = "VIRTIO"
    }
  ]
}
```

### Device Attributes Reference

#### NIC Device Attributes

| Attribute | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `type` | string | No | `VIRTIO` | NIC type (VIRTIO, E1000, E1000E, RTL8139) |
| `nic_attach` | string | **Yes** | - | Physical interface to attach to |
| `mac` | string | No | auto-generated | MAC address (leave empty for auto-gen) |
| `trust_guest_rx_filters` | bool | No | `false` | Trust guest RX filters |

#### Disk Device Attributes

| Attribute | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `path` | string | **Yes** | - | Path to zvol or file |
| `type` | string | No | `VIRTIO` | Disk type (VIRTIO, AHCI, SCSI) |
| `iotype` | string | No | - | IO type (THREADS, NATIVE) |
| `physical_sectorsize` | number | No | - | Physical sector size in bytes |
| `logical_sectorsize` | number | No | - | Logical sector size in bytes |

#### CDROM Device Attributes

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| `path` | string | **Yes** | Path to ISO file |

### Breaking Changes

None. This is a backward-compatible addition.

### Bug Fixes

- Fixed issue where VMs created without devices had no network connectivity
- Device reading now correctly populates all device types in Terraform state
- MAC addresses properly exported even when auto-generated by TrueNAS

### Documentation

- Added comprehensive `examples/vm-with-devices/` directory with:
  - Complete example configurations
  - README with usage instructions
  - Troubleshooting guide
  - Talos Linux worker node example
- Updated CHANGELOG with detailed device configuration documentation

### Prerequisites for Using Device Features

1. **For Disk Devices**: Create zvols before referencing them
   ```bash
   zfs create -V 32G pool/vms/myvm-disk0
   ```

2. **For CDROM Devices**: Upload ISO files to TrueNAS storage
   ```bash
   # ISO files should be accessible at /mnt/pool/path/to/file.iso
   ```

3. **For NIC Devices**: Ensure physical network interface exists
   - Check available interfaces in TrueNAS UI: Network ‚Üí Interfaces
   - Common interfaces: `eno1`, `eno2`, `br0`, etc.

### Known Limitations

1. **VM Names**: Must be alphanumeric only (no hyphens, underscores, or special characters)
   - ‚úÖ Good: `myvm`, `talosworker01`, `ubuntu2204`
   - ‚ùå Bad: `my-vm`, `talos_worker_01`, `ubuntu-22.04`

2. **Device Updates**: Changing device configuration after VM creation may require VM restart

3. **MAC Address Display**: Auto-generated MAC addresses show as `null` in Terraform output until VM is started (this is a TrueNAS API behavior)

### Migration Guide

If you have existing VMs created with earlier versions:

1. **Option A: Add devices to existing VMs**
   - Currently not supported - devices can only be added during creation
   - Use TrueNAS UI to add devices manually

2. **Option B: Recreate VMs with devices** (Recommended)
   ```bash
   # 1. Export current VM configuration
   terraform show

   # 2. Add device configuration to your .tf files
   # 3. Destroy old VM
   terraform destroy -target=truenas_vm.example

   # 4. Create new VM with devices
   terraform apply
   ```

### Testing

This release has been tested with:
- ‚úÖ Single NIC, single disk, single CDROM
- ‚úÖ Multiple NICs (2+)
- ‚úÖ Multiple disks (2+)
- ‚úÖ Auto-generated MAC addresses
- ‚úÖ Custom MAC addresses
- ‚úÖ Talos Linux worker nodes
- ‚úÖ Ubuntu VMs
- ‚úÖ VM creation and destruction
- ‚úÖ Device reading and state management

### What's Next

Planned for v0.3.0:
- Device update support (add/remove devices from existing VMs)
- Display device configuration
- USB device passthrough
- PCI device passthrough
- Network bridge management

### Feedback

If you encounter any issues or have suggestions, please open an issue on GitHub:
https://github.com/baladithyab/terraform-provider-truenas/issues

### Contributors

- @baladithyab - Device configuration implementation and testing

---

**Full Changelog**: https://github.com/baladithyab/terraform-provider-truenas/compare/v0.2.12...v0.2.13

